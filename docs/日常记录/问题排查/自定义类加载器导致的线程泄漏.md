# 线程泄漏排查

> 客户环境现象：JVM参数配置30G，但docker容器实际使用为51G

> 排查过程：   
> 发现有线程泄漏，在jstack中可以看到总线程数为4000，3300多个和hadoop相关   
> 其中主要是 org.apache.hadoop.fs.FileSystem$Statistics$StatisticsDataReferenceCleaner 和 org.apache.hadoop.hdfs.PeerCache   
> 
> 查看代码，该线程是 static 代码块中创建并启动的，所以理论上应该只在jvm中出现一次。通过MAT查看heapdump文件，查看此类线程的类加载器   
> 发现出现了大量的类加载器实例URLClassLoader，所以每次加载创建一个线程，导致了很多线程   
> 根据关键字搜索代码，发现在同一个工程下对不同逻辑使用不同jar（hive和inceptor），所以每次都new一个新的ClassLoder   

> 解决方案：   
> 1.使用单例模式创建两个类加载器，不重复new    
> 2.由于kafka connect本身已经对不同的connector使用了不同的plugin class loader，所以可以将有依赖冲突的jar分别打包   

